# ğŸ” Seccomp (Secure Computing Mode)

Seccomp est une **fonction de sÃ©curitÃ© du noyau Linux** permettant de limiter les **syscalls** qu'un conteneur peut exÃ©cuter. Cela rÃ©duit la surface d'attaque.

---

## ğŸ³ **1. Seccomp dans Docker**

```bash
$ docker run r.j3ss.co/amicontained amicontained
```

ğŸ” **Ce que fait cette commande :**

* Lance le conteneur `amicontained`, un outil de diagnostic de sÃ©curitÃ©.
* Affiche :

  * `blocked Syscalls (64)` â†’ les appels systÃ¨me bloquÃ©s.
  * `seccomp: filtering` â†’ seccomp est actif dans Docker par dÃ©faut.

---

## â˜¸ï¸ **2. Seccomp dans Kubernetes**

### ğŸ”¹ DÃ©ploiement dâ€™un pod avec la mÃªme image :

```bash
$ kubectl run amicontained --image=r.j3ss.co/amicontained --command -- amicontained
$ kubectl logs amicontained
```

ğŸ‘‰ Permet de vÃ©rifier si **Seccomp est activÃ© par dÃ©faut** dans Kubernetes (normalement oui via `RuntimeDefault`).

---

## ğŸ›¡ï¸ 3. **Configurer Seccomp manuellement avec un profil personnalisÃ©**

### ğŸ“ CrÃ©er un rÃ©pertoire pour les profils :

```bash
mkdir -p /var/lib/kubelet/seccomp/profiles
```

### ğŸ“ CrÃ©er un fichier de profil : `audit.json`

```json
{
  "defaultAction": "SCMP_ACT_LOG"
}
```

â¡ï¸ Ce profil **nâ€™empÃªche rien**, mais **loggue tous les syscalls**.

---

## ğŸ“„ 4. DÃ©ploiement dâ€™un pod avec le profil

### Exemple YAML (test-audit.yml) :

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: audit-nginx
spec:
  securityContext:
    seccompProfile:
      type: Localhost
      localhostProfile: profiles/audit.json
  containers:
  - name: audit-nginx
    image: nginx
    securityContext:
      allowPrivilegeEscalation: false
```

ğŸ“Œ `allowPrivilegeEscalation: false`
â¡ï¸ EmpÃªche un processus de devenir root mÃªme sâ€™il a les capacitÃ©s.

---

## ğŸ§  5. Lire les logs systÃ¨me

```bash
grep syscall /var/log/syslog
```

ğŸ” Cela affiche les **syscalls exÃ©cutÃ©s** par le pod et logguÃ©s via seccomp.

### â“ "Syscall=35" â†’ Ã§a veut dire quoi ?

```bash
grep -w 35 /usr/include/asm/unistd_64.h
```

ğŸ’¡ RÃ©sultat :

```c
#define __NR_nanosleep 35
```

â¡ï¸ `35` correspond au syscall `nanosleep`.

---

## ğŸ”¬ 6. Alternative avec Tracee (outil eBPF)

```bash
docker run --name tracee --rm --privileged --pid=host \
-v /lib/modules/:/lib/modules/:ro \
-v /usr/src:/usr/src:ro \
-v /tmp/tracee:/tmp/tracee aquasec/tracee:0.4.0 --trace container=new
```

ğŸ§  Tracee **observe tous les syscalls** grÃ¢ce Ã  eBPF.

---

## ğŸš« 7. CrÃ©er un profil qui bloque tout (âš ï¸ attention !)

```json
{
  "defaultAction": "SCMP_ACT_ERRNO"
}
```

â¡ï¸ Cela **bloque tous les syscalls** par dÃ©faut â†’ le pod ne dÃ©marre pas :

```
Container cannot run
```

ğŸ“Œ UtilisÃ© pour **tester la force de restriction**.

---

## ğŸ§¾ RÃ©sumÃ© des termes

| Terme                             | Signification                              |
| --------------------------------- | ------------------------------------------ |
| `SCMP_ACT_LOG`                    | Log seulement les syscalls                 |
| `SCMP_ACT_ERRNO`                  | Bloque les syscalls avec une erreur        |
| `RuntimeDefault`                  | Utilise le profil par dÃ©faut de containerd |
| `allowPrivilegeEscalation: false` | EmpÃªche un binaire de devenir root         |