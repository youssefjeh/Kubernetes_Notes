## ğŸ¯ **Objectif : Utiliser Falco pour dÃ©tecter les menaces**

### ğŸ” **Ã‰tape 1 : Surveiller Falco**

Dans un terminal, tu lances la surveillance de Falco :

```bash
ssh node01
journalctl -fu falco
```

---

### ğŸ§ª **Ã‰tape 2 : ExÃ©cuter une action suspecte**

Dans un **deuxiÃ¨me terminal**, tu ouvres un shell dans un conteneur pour faire une action Ã  surveiller :

```bash
kubectl exec -ti nginx -- bash
```

Puis dans ce conteneur, tu fais une action interdite, par exemple :

```bash
touch /etc/passwd
```

---

### ğŸ“œ **Exemple de rÃ¨gle Falco (rules.yml)**

Voici un exemple simple de rÃ¨gle personnalisÃ©e :

```yaml
- rule: Ã‰criture fichier systÃ¨me sensible
  desc: DÃ©tecte si quelquâ€™un essaie de modifier un fichier systÃ¨me comme /etc/passwd
  condition: evt.type = "open" and fd.name = "/etc/passwd" and evt.arg.flags contains "O_WRONLY"
  output: "[Alerte Falco] Tentative de modification de /etc/passwd par %user.name (commande: %proc.name)"
  priority: CRITICAL
```

---

### ğŸ§© **Macro (rÃ©utilisable)**

```yaml
- macro: fichiers_sensibles
  condition: fd.name in (/etc/passwd, /etc/shadow)
```

---

### ğŸ“‹ **Liste (listes personnalisÃ©es)**

```yaml
- list: utilisateurs_sensibles
  items: [root, admin]
```

---

### ğŸ” **Filtres Sysdig utiles**

UtilisÃ©s pour crÃ©er des rÃ¨gles ou analyser :

```
container.id     # ID du conteneur
proc.name        # Nom du processus
fd.name          # Nom du fichier ou ressource
evt.type         # Type d'Ã©vÃ©nement (ex: open, execve)
user.name        # Nom de lâ€™utilisateur
container.img.repository  # Nom de lâ€™image du conteneur
```







## ğŸ›¡ï¸ **But de la rÃ¨gle**

> **DÃ©tecter si quelquâ€™un tente de modifier un fichier systÃ¨me sensible comme `/etc/passwd`.**

---

### ğŸ“„ **Contenu dÃ©taillÃ© de la rÃ¨gle**

```yaml
- rule: Ã‰criture fichier systÃ¨me sensible
```

* **Nom de la rÃ¨gle** : Ce titre est libre, ici il dÃ©crit clairement le but de la rÃ¨gle.

---

```yaml
  desc: DÃ©tecte si quelquâ€™un essaie de modifier un fichier systÃ¨me comme /etc/passwd
```

* **Description** : Une phrase explicative sur ce que fait la rÃ¨gle. Cela aide Ã  comprendre son utilitÃ© dans le fichier.

---

```yaml
  condition: evt.type = "open" and fd.name = "/etc/passwd" and evt.arg.flags contains "O_WRONLY"
```

* **condition** : Câ€™est le **cÅ“ur de la rÃ¨gle**. Elle dÃ©finit quand une alerte doit Ãªtre dÃ©clenchÃ©e.

ğŸ” DÃ©tail ligne par ligne :

* `evt.type = "open"` â†’ Surveille les Ã©vÃ©nements dâ€™ouverture de fichier.
* `fd.name = "/etc/passwd"` â†’ Cible spÃ©cifiquement le fichier `/etc/passwd`.
* `evt.arg.flags contains "O_WRONLY"` â†’ DÃ©tecte si le fichier est ouvert en **mode Ã©criture seulement**, ce qui est suspect.

**Conclusion** : Si un processus essaie dâ€™**ouvrir `/etc/passwd` en Ã©criture**, cette rÃ¨gle va sâ€™activer.

---

```yaml
  output: "[Alerte Falco] Tentative de modification de /etc/passwd par %user.name (commande: %proc.name)"
```

* **output** : Câ€™est le **message** qui sera affichÃ© dans les logs de Falco si la rÃ¨gle se dÃ©clenche.

ğŸ“¢ Il contient des variables dynamiques :

* `%user.name` â†’ Nom de lâ€™utilisateur qui a lancÃ© la commande.
* `%proc.name` â†’ Nom du processus ou de la commande utilisÃ©e.

Exemple dâ€™alerte gÃ©nÃ©rÃ©e :

```
[Alerte Falco] Tentative de modification de /etc/passwd par root (commande: vim)
```

---

```yaml
  priority: CRITICAL
```

* **priority** : Le niveau de gravitÃ© de la rÃ¨gle. Ici :

  * `CRITICAL` = alerte trÃ¨s urgente.
  * Autres niveaux possibles : `HIGH`, `MEDIUM`, `LOW`, `INFO`.

---