## üîê S√©curit√© des images dans Kubernetes

### 1. ‚úÖ **Utiliser des credentials pour acc√©der √† des registres priv√©s**
```yaml
imagePullSecrets:
  - name: private-reg-cred
```
> Permet d‚Äôutiliser une image depuis un registre priv√© s√©curis√© en ajoutant le secret au `pod.spec`.

---

## ‚ö™Ô∏è Whitelisting des registres autoris√©s

### ‚ùì Comment emp√™cher l'utilisation d'images provenant de registres non autoris√©s ?

#### Options possibles :

### ‚úÖ Option 1 : **Admission Controllers / Admission Webhooks**
- Impl√©mentation native Kubernetes.
- **ValidatingAdmissionWebhook** ou **MutatingAdmissionWebhook**.
- Utilise un webhook pour valider ou modifier les requ√™tes API.
- Permet de refuser les images qui ne viennent pas d‚Äôun registre autoris√© (ex: refuser tout sauf `internal-reg.io`).

---

### ‚úÖ Option 2 : **OPA Gatekeeper (Open Policy Agent)**
- Plus flexible, bas√© sur des r√®gles en Rego.
- Peut aussi v√©rifier les registres d‚Äôimages via des contraintes personnalis√©es.

---

### ‚úÖ Option 3 : **ImagePolicyWebhook (approche historique mais officielle)**
- Moins utilis√© en production moderne que OPA.
- N√©cessite une **configuration sp√©cifique dans l'API Server**.
- Rejette les pods si l'image ne provient pas d'un registre autoris√©.

---

## üîß LAB : Impl√©mentation de l'ImagePolicyWebhook

### √âtape 1 : D√©ploiement d‚Äôun Pod test avec une image non autoris√©e
```yaml
# /root/nginx-latest.yml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: nginx-latest
spec:
  replicas: 1
  selector:
    matchLabels:
      tier: nginx-latest
  template:
    metadata:
      labels:
        tier: nginx-latest
    spec:
      containers:
      - name: nginx-latest
        image: nginx  # image latest non autoris√©e
```

---

### √âtape 2 : D√©ployer le serveur Webhook
```yaml
# image-policy-webhook.yaml
apiVersion: v1
kind: Service
metadata:
  name: image-bouncer-webhook
spec:
  type: NodePort
  ports:
    - port: 443
      targetPort: 1323
      nodePort: 30080
  selector:
    app: image-bouncer-webhook
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: image-bouncer-webhook
spec:
  template:
    spec:
      containers:
        - image: kainlite/kube-image-bouncer:latest
          args:
            - "--registry-whitelist=docker.io,registry.k8s.io"
```
> `--registry-whitelist`: d√©termine les registres autoris√©s.

---

### √âtape 3 : Configuration d‚ÄôAdmission dans l‚ÄôAPI Server

#### a. Fichier `/etc/kubernetes/pki/admission_kube_config.yaml`
```yaml
apiVersion: v1
kind: Config
clusters:
- cluster:
    certificate-authority: /etc/kubernetes/pki/server.crt
    server: https://image-bouncer-webhook:30080/image_policy
  name: bouncer_webhook
...
```

#### b. Fichier `/etc/kubernetes/pki/admission_configuration.yaml`
```yaml
apiVersion: apiserver.config.k8s.io/v1
kind: AdmissionConfiguration
plugins:
- name: ImagePolicyWebhook
  configuration:
    imagePolicy:
      kubeConfigFile: /etc/kubernetes/pki/admission_kube_config.yaml
      allowTTL: 50
      denyTTL: 50
      retryBackoff: 500
      defaultAllow: false
```

---

### √âtape 4 : Activer le plugin dans le manifest API server

Fichier : `/etc/kubernetes/manifests/kube-apiserver.yaml`
```yaml
- --enable-admission-plugins=NodeRestriction,ImagePolicyWebhook
- --admission-control-config-file=/etc/kubernetes/pki/admission_configuration.yaml
```
> Cela active la validation des images par webhook. L'API Server red√©marre automatiquement.

---

## ‚úÖ V√©rification et test

1. Supprimer et red√©ployer le pod :
```bash
kubectl delete -f /root/nginx-latest.yml
kubectl apply -f /root/nginx-latest.yml
```

2. Consulter les erreurs :
```bash
kubectl describe rs nginx-latest
```
> Une erreur de type "image not from whitelisted registry" devrait appara√Ætre.

---

## üõ† Correction de l'erreur

Modifier l'image dans le fichier `nginx-latest.yml` :
```yaml
image: nginx:1.19  # Image sp√©cifique depuis Docker Hub autoris√©
```

---

## üîÅ R√©sum√© des fichiers cl√©s

| Fichier                                      | R√¥le                                               |
|---------------------------------------------|----------------------------------------------------|
| `image-policy-webhook.yaml`                 | D√©ploie le service de validation d‚Äôimages          |
| `admission_kube_config.yaml`                | Kubeconfig pour le webhook                         |
| `admission_configuration.yaml`              | Active l'ImagePolicyWebhook                        |
| `kube-apiserver.yaml`                       | Active le plugin dans l‚ÄôAPI Server (static pod)    |
| `/etc/hosts`                                | Entr√©e DNS pour `image-bouncer-webhook` si besoin  |
