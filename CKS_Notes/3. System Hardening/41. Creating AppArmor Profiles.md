## ğŸ”¹ **1. Script `add_data.sh`**

```bash
#!/bin/bash
data_directory=/opt/app/data
mkdir -p ${data_directory}
echo "=> File created at $(date)" | tee ${data_directory}/create.log
```

ğŸ‘‰ Ce script :
- CrÃ©e un rÃ©pertoire `/opt/app/data`
- Ã‰crit un message dans `/opt/app/data/create.log` contenant la date actuelle

---

## ğŸ”¹ **2. ExÃ©cution du script**

```bash
./add_data.sh
```

Tu obtiens une sortie comme :
```
=> File created at Mon Mar 12 03:29:22 UTC 2021
```

---

## ğŸ”¹ **3. Installation AppArmor Tools**

```bash
apt-get install -y apparmor-utils
```

Tu installes les outils nÃ©cessaires pour manipuler les profils AppArmor.

---

## ğŸ”¹ **4. GÃ©nÃ©ration du profil AppArmor**

```bash
aa-genprof /root/add_data.sh
```

- Cela lance la **crÃ©ation interactive** d'un profil AppArmor pour `/root/add_data.sh`
- Il met le script en **mode "complain"**, ce qui signifie quâ€™il enregistre les violations de sÃ©curitÃ© **sans les bloquer**
- Tu dois exÃ©cuter le script dans un **autre terminal** pour que AppArmor puisse observer ses actions :

```bash
./add_data.sh
```

---

## ğŸ”¹ **5. Analyse des actions du script (logs)**

Dans la session `aa-genprof`, AppArmor te montre :

- `/usr/bin/mkdir` â€” on te demande si tu veux permettre cette exÃ©cution â†’ tu choisis `i` (autoriser)
- `/usr/bin/tee` â†’ tu choisis `i` (autoriser)
- `/dev/tty` â†’ tu choisis `A` (ajouter en lecture/Ã©criture pour le propriÃ©taire)
- `/proc/filesystems` â†’ tu choisis **"Deny"** (refuser l'accÃ¨s)

---

## ğŸ”¹ **6. Fin du profilage**

Tu appuies sur :
- `s` â†’ pour **sauvegarder**
- `F` â†’ pour **finir**

---

## ğŸ”¹ **7. VÃ©rification**

```bash
aa-status
cat /etc/apparmor.d/root.add_data.sh
```

Tu vÃ©rifies que le profil a bien Ã©tÃ© crÃ©Ã© pour `/root/add_data.sh`.

---

## ğŸ”¹ **8. Modification du script**

Si tu modifies :

```bash
data_directory=/opt
```

Alors le script va essayer de crÃ©er le fichier ici :

```bash
/opt/create.log
```

Mais ce nâ€™Ã©tait **pas autorisÃ© dans le profil AppArmor**, donc tu obtiens une erreur :

```
tee: /opt/create.log: Permission denied
```

---

## ğŸ”¹ **9. Gestion manuelle du profil AppArmor**

Tu utilises :

```bash
apparmor_parser /etc/apparmor.d/root.add_data.sh
```
ğŸ‘‰ pour **(re)charger** le profil

```bash
apparmor_parser -R /etc/apparmor.d/root.add_data.sh
```
ğŸ‘‰ pour **retirer** le profil

```bash
ln -s /etc/apparmor.d/root.add_data.sh /etc/apparmor.d/disable/
```
ğŸ‘‰ pour **dÃ©sactiver** le profil en le liant dans le dossier `disable`



## mais pourquoi on a obtenu cet erreur ?

```
tee: /opt/create.log: Permission denied
```

vient **directement dâ€™AppArmor**, car **le chemin `/opt/create.log` nâ€™est pas autorisÃ©** dans le **profil de sÃ©curitÃ©** que tu as crÃ©Ã© pour ton script `/root/add_data.sh`.

---

### ğŸ” DÃ©tail technique

Lorsque tu as gÃ©nÃ©rÃ© le profil AppArmor (`aa-genprof /root/add_data.sh`), tu as exÃ©cutÃ© le script tel quâ€™il Ã©tait Ã  ce moment-lÃ  :

```bash
data_directory=/opt/app/data
```

Donc AppArmor a **enregistrÃ©** et **autorisÃ©** uniquement lâ€™accÃ¨s Ã  :

```
/opt/app/data/create.log
```

Mais ensuite, tu as modifiÃ© le script :

```bash
data_directory=/opt
```

Et maintenant, le script tente dâ€™Ã©crire dans :

```
/opt/create.log
```

Or **ce chemin nâ€™est pas autorisÃ©** dans le profil actuel, donc AppArmor **bloque l'accÃ¨s**, ce qui donne :

```
tee: /opt/create.log: Permission denied
```

---

### ğŸ›¡ Pourquoi AppArmor fait Ã§a ?

AppArmor est lÃ  pour **limiter les accÃ¨s dâ€™un programme aux fichiers, rÃ©pertoires, commandes, etc.**, selon un profil bien prÃ©cis. Cela permet de **rÃ©duire les dÃ©gÃ¢ts en cas de faille de sÃ©curitÃ©**.

---

### ğŸ›  Comment corriger l'erreur ?

Tu as 3 options :

1. **Modifier le profil AppArmor** pour y autoriser `/opt/create.log` :

   ```bash
   aa-logprof
   ```

   ou relancer `aa-genprof` et exÃ©cuter le script avec la nouvelle version.

2. **Revenir Ã  lâ€™ancien chemin** (`/opt/app/data`) dans ton script.

3. **DÃ©sactiver temporairement le profil AppArmor** :

   ```bash
   apparmor_parser -R /etc/apparmor.d/root.add_data.sh
   ```