# ğŸ” AppArmor & Capabilities dans Kubernetes

## Â« Hardening Â» dâ€™un pod Ubuntu avec un profil *deny-write*

> **TL;DR** â€“ Nous crÃ©ons un pod **ubuntu-sleeper** protÃ©gÃ© par AppArmor, puis dÃ©montrons quâ€™il ne peut ni Ã©crire dans `/tmp` ni changer lâ€™horloge systÃ¨me faute des **capabilities** nÃ©cessaires. En bonus : commandes pratiques pour inspecter les capacitÃ©s dâ€™un binaire ou dâ€™un processus.

---

## 1. VÃ©rifier que le profil AppArmor est chargÃ© sur chaque nÅ“ud

```bash
sudo aa-status | grep apparmor-deny-write
```

Le profil `apparmor-deny-write` doit apparaÃ®tre en mode *enforced*.

---

## 2. Manifeste du pod

<details>
<summary>ğŸ…°ï¸ Ancienne mÃ©thode (annotation beta)</summary>

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: ubuntu-sleeper
  annotations:
    container.apparmor.security.beta.kubernetes.io/ubuntu-sleeper: localhost/apparmor-deny-write
spec:
  containers:
  - name: ubuntu-sleeper
    image: ubuntu
    command: ["sh", "-c", "echo 'Sleeping for an hour!!' && sleep 1h"]
```

</details>

<details open>
<summary>ğŸ†• MÃ©thode moderne (Kubernetes â‰¥ v1.28)</summary>

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: ubuntu-sleeper
spec:
  containers:
  - name: ubuntu-sleeper
    image: ubuntu
    command: ["sh", "-c", "echo 'Sleeping for an hour!!' && sleep 1h"]
    securityContext:
      appArmorProfile:
        type: Localhost
        localhostProfile: apparmor-deny-write
```

</details>

---

## 3. DÃ©ploiement rapide & tests

```bash
kubectl apply -f ubuntu-sleeper.yaml
kubectl logs ubuntu-sleeper
# âœ Sleeping for an hour!!

# Tentative dâ€™Ã©criture bloquÃ©e
kubectl exec ubuntu-sleeper -- touch /tmp/test
# âœ touch: cannot touch '/tmp/test': Permission denied
```

Le profil *deny-write* fait son travail ğŸ”’.

---

## 4. Capabilities : comprendre les permissions de bas niveau

### 4.1 Besoins dâ€™un **binaire**

```bash
# Quelles capabilities sont requises par /usr/bin/ping ?
getcap /usr/bin/ping
# âœ /usr/bin/ping = cap_net_admin,cap_net_raw+p
```

*Ping* a donc besoin de `CAP_NET_RAW` et `CAP_NET_ADMIN`.

### 4.2 Besoins dâ€™un **processus** dÃ©jÃ  lancÃ©

```bash
# Trouver le PID du dÃ©mon sshd
ps -ef | grep /usr/sbin/ssh[d]      # ex. PID 779

# Quelles caps le PID 779 possÃ¨de-t-il ?
getpcaps 779
```

(Ou `getcap /proc/779/exe` sur certains systÃ¨mes.)

### 4.3 Pourquoi notre pod ne peut-il pas changer la date ?

* La commande `date -s "2025-05-30"` exige `CAP_SYS_TIME`.
* Un conteneur **mÃªme en root** est dÃ©marrÃ© avec un jeu rÃ©duit de capacitÃ©s.
* Avec le runtime **Docker**, seules **14 capabilities** sont accordÃ©es par dÃ©faut :

```
CAP_CHOWN               CAP_DAC_OVERRIDE     CAP_FSETID
CAP_FOWNER              CAP_MKNOD            CAP_NET_RAW
CAP_SETGID              CAP_SETUID           CAP_SETFCAP
CAP_SETPCAP             CAP_NET_BIND_SERVICE CAP_SYS_CHROOT
CAP_KILL                CAP_AUDIT_WRITE
```

Comme `CAP_SYS_TIME` nâ€™en fait pas partie, le rÃ©glage manuel de lâ€™horloge est refusÃ© :

```bash
kubectl exec ubuntu-sleeper -- date -s "2030-01-01"
# âœ date: cannot set date: Operation not permitted
```

> **Rappel** : on peut *ajouter* ou *supprimer* des capabilities dans Kubernetes via
> `securityContext.capabilities.add|drop`.

---

## 5. RÃ©sumÃ©

| Ã‰lÃ©ment          | Fonction                                                          |
| ---------------- | ----------------------------------------------------------------- |
| **AppArmor**     | Confinement *path-based* ; ici : blocage Ã©criture.                |
| **Capabilities** | GranularitÃ© *kernel* ; ğŸ³ Docker nâ€™en autorise que 14 par dÃ©faut. |
| **RÃ©sultat**     | Pod root **incapable** dâ€™Ã©crire ou de rÃ©gler lâ€™horloge.           |

> Combiner AppArmor **et** la gestion fine des capabilities permet de rÃ©duire drastiquement la surface dâ€™attaque dâ€™un conteneur.

---

### ğŸ“š Pour aller plus loin

* `kubectl explain pod.spec.securityContext`
* [Kubernetes Hardening Guide â€“ NSA/CISA](https://media.defense.gov/)
* `man 7 capabilities` et `man apparmor`