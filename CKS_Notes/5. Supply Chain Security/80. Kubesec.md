## âœ… **Pipeline de SÃ©curitÃ© Kubernetes avec Kubesec**

### 1. ğŸ”§ **Ã‰tapes gÃ©nÃ©rales du pipeline**
```text
create File â†’ analyze Files â†’ kubectl â†’ Authentication â†’ Authorization
```

---

## ğŸ” **Analyse statique des fichiers Kubernetes**

> Lâ€™analyse statique permet de vÃ©rifier les ressources **avant** quâ€™elles ne soient poussÃ©es sur le cluster pour appliquer des politiques de sÃ©curitÃ©.

### Outil utilisÃ© : **Kubesec**

- Analyse les fichiers YAML ou JSON Kubernetes.
- Retourne un score de sÃ©curitÃ©.
- Peut s'utiliser localement ou via HTTP API.

---

### ğŸš€ **Commandes de base**

```bash
# Analyse directe dâ€™un fichier
kubesec scan pod.yml

# Envoi via curl Ã  lâ€™API Kubesec
curl -qSX POST --data-binary @"pod.yml" https://v2.kubesec.io/scan

# Lancer le service Kubesec localement (HTTP)
kubesec http 8080 &
```

---

## ğŸ”¬ **LAB : Analyse de fichier YAML avec Kubesec**

### 1. ğŸ“¥ **Installation de Kubesec sur controlplane**

```bash
wget https://github.com/controlplaneio/kubesec/releases/download/v2.13.0/kubesec_linux_amd64.tar.gz
tar -xvf kubesec_linux_amd64.tar.gz
mv kubesec /usr/bin/
```

> ğŸ”¹ VÃ©rifie que `kubesec` est globalement accessible (`which kubesec`)

---

### 2. â“ **Formats supportÃ©s par Kubesec**
```text
SupportÃ©s :
- YAML
- JSON

Non supportÃ© : Tout autre format (ex: XML, CSV, etc.)
```

---

### 3. ğŸ“„ **Analyse de `/root/node.yaml`**

```bash
kubesec scan node.yaml
```

ğŸ“Œ **Rapport de sortie :**
- `"message": "Failed with a score of -27 points"`
- â— **Fail critique :** `privileged: true`

---

### 4. ğŸ§ª **Contenu partiel du rapport Kubesec**
#### âš ï¸ **Critique**
```json
{
  "id": "Privileged",
  "selector": "containers[] .securityContext .privileged == true",
  "reason": "Privileged containers can allow almost completely unrestricted host access",
  "points": -30
}
```

#### âœ… **PassÃ©s**
```json
{
  "id": "ServiceAccountName",
  "selector": ".spec .serviceAccountName",
  "points": 3
}
```

#### ğŸ“ **Conseils dâ€™amÃ©lioration (Advisory)**
- Ajouter `runAsNonRoot: true`
- `readOnlyRootFilesystem: true`
- DÃ©finir des limites CPU/mÃ©moire
- Ajouter des annotations AppArmor/Seccomp
- Capabilities: `drop: ["ALL"]`

---

### 5. ğŸ› ï¸ **Correction du fichier `node.yaml`**

#### ğŸ”§ Modifications Ã  appliquer :
- Remplacer :
```yaml
privileged: true
```
- Par :
```yaml
privileged: false
```

---

### 6. âœ… **Nouvelle analyse**

```bash
kubesec scan node.yaml > /root/kubesec_report.json
```

ğŸŸ¢ **RÃ©sultat attendu :**
```json
"message": "Passed with a score of 3 points"
```

---

## ğŸ“Œ **RÃ©sumÃ© final des Ã©tapes Ã  retenir**
1. Installer `kubesec` (binaire dans `/usr/bin/`)
2. CrÃ©er ou rÃ©cupÃ©rer le fichier YAML (ex: `node.yaml`)
3. Scanner avec `kubesec scan node.yaml`
4. Lire et interprÃ©ter le rapport
5. Corriger les points critiques et advisory
6. Re-scanner jusquâ€™Ã  obtenir un **status "Passed"**
