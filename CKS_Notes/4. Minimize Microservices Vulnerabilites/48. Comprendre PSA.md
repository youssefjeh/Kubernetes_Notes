## üîê Comprendre Pod Security Admission (PSA) dans Kubernetes

---

### üß† 1. Qu‚Äôest-ce que **Pod Security Admission** ?

Pod Security Admission est un **m√©canisme de s√©curit√© int√©gr√© √† Kubernetes** qui **valide les Pods avant leur cr√©ation**, en fonction de r√®gles de s√©curit√© pr√©d√©finies appel√©es **Pod Security Standards (PSS)**.

---

### üß© 2. Les trois niveaux de s√©curit√© disponibles

| Niveau         | Objectif                               | Exemple                                        |
| -------------- | -------------------------------------- | ---------------------------------------------- |
| **Privileged** | Aucune restriction (pas s√©curis√©)      | Acc√®s root, mont√©e en privil√®ges               |
| **Baseline**   | S√©curis√© pour la plupart des applis    | Interdit `privileged=true`                     |
| **Restricted** | Niveau le plus strict (z√©ro privil√®ge) | N√©cessite `runAsNonRoot=true`, `seccomp`, etc. |

---

### ‚öôÔ∏è 3. V√©rifier si PSA est activ√©

Tu peux v√©rifier si PSA est bien activ√© avec cette commande :

```bash
kubectl exec -n kube-system kube-apiserver-controlplane \
-- kube-apiserver -h | grep enable-admission
```

---

### üè∑Ô∏è 4. Activer PSA au niveau d‚Äôun namespace

Pour activer la s√©curit√© dans un namespace, on lui applique des **labels sp√©cifiques** :

```bash
kubectl label namespaces <namespace> pod-security.kubernetes.io/<MODE>=<LEVEL>
```

Exemples :

```bash
kubectl label namespaces alpha pod-security.kubernetes.io/warn=baseline
kubectl label namespaces beta \
  pod-security.kubernetes.io/enforce=baseline \
  pod-security.kubernetes.io/warn=restricted
```

---

### üß™ 5. Test avec un Pod qui viole les r√®gles

#### ‚úÖ Fichier `baseline-pod.yaml`

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: baseline-pod
  namespace: alpha
spec:
  containers:
  - image: nginx
    name: baseline-pod
    securityContext:
       privileged: true
```

Cr√©ation :

```bash
kubectl apply -f baseline-pod.yaml
```

üî∏ **R√©sultat** :

```
Warning: would violate PodSecurity "baseline:latest": privileged (container "baseline-pod" must not set securityContext.privileged=true)
```

‚û° Le pod est cr√©√© malgr√© l'avertissement car le mode est `warn`, pas `enforce`.

---

### üîç 6. Exemple avec plusieurs niveaux PSA dans un m√™me namespace

#### üßæ Fichier `multi-psa.yaml`

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: multi-psa
  namespace: beta
spec:
  containers:
  - name: multi-psa
    image: nginx
    securityContext:
      runAsUser: 0
```

Cr√©ation :

```bash
kubectl apply -f multi-psa.yaml
```

üî∏ **R√©sultat** :

```
Warning: would violate PodSecurity "restricted:latest": ...
```

‚û° Ce pod **viole le niveau `restricted`**, mais est quand m√™me **cr√©√©** car `restricted` est en **warn**, pas enforce.

---

### üß∞ 7. Config globale via le fichier `admission-configuration.yaml`

```yaml
apiVersion: admissionregistration.k8s.io/v1
kind: AdmissionConfiguration
plugins:
  - name: PodSecurity
    configuration:
      apiVersion: pod-security.admission.config.k8s.io/v1
      kind: PodSecurityConfiguration
      defaults:
        enforce: baseline
        audit: restricted
        warn: restricted
      exemptions:
        namespaces: [my-namespace]
```

‚úÖ **Interpr√©tation** :

* `baseline` est **enforc√©** partout
* `restricted` est **audit** et **warn**
* Le namespace `my-namespace` est **exempt√© des r√®gles**

---

## üß† R√©sum√© visuel

| Namespace      | Enforce    | Warn         | R√©sultat                                                                 |
| -------------- | ---------- | ------------ | ------------------------------------------------------------------------ |
| `alpha`        | (rien)     | `baseline`   | Cr√©ation autoris√©e avec **warnings** si violation de `baseline`          |
| `beta`         | `baseline` | `restricted` | **Cr√©ation bloqu√©e** si violation `baseline`, warnings pour `restricted` |
| `my-namespace` | (exempt√©)  | (exempt√©)    | Pas de v√©rification PSA                                                  |
