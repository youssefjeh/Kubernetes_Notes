## ğŸ›¡ï¸ Câ€™est quoi **AppArmor** (Application Armor) ?

AppArmor est comme une **barriÃ¨re de sÃ©curitÃ©** autour dâ€™une application sous Linux.

Imagine que tu veux prÃªter ta voiture Ã  quelquâ€™un, mais tu veux limiter ce quâ€™il peut faire avec :

* Tu autorises Ã  **dÃ©marrer la voiture**, mais **pas Ã  ouvrir le coffre**.
* Tu autorises Ã  **Ã©couter la radio**, mais **pas Ã  toucher au GPS**.

â¡ï¸ **AppArmor fait pareil pour une application ou un conteneur.**
Il lui dit : **"Tu as le droit d'accÃ©der Ã  Ã§aâ€¦ mais pas Ã  Ã§a."**

---

## âš™ï¸ Comment Ã§a marche ?

AppArmor utilise des **profils de sÃ©curitÃ©** : des fichiers textes qui dÃ©crivent :

* Quels fichiers peuvent Ãªtre lus ou modifiÃ©s,
* Si on peut Ã©crire dans `/proc`,
* Si on peut faire des montages (`mount`),
* Etc.

---

## ğŸ” 1. Est-ce quâ€™AppArmor est activÃ© ?

```bash
cat /sys/module/apparmor/parameters/enabled
```

Si Ã§a affiche `Y` âœ AppArmor est activÃ© sur la machine.

---

## ğŸ“„ 2. Voir les profils AppArmor disponibles

```bash
cat /sys/kernel/security/apparmor/profiles
```

Tu y verras des profils comme :

* `docker-default` : utilisÃ© automatiquement pour les conteneurs Docker.
* `apparmor-deny-write` : bloque lâ€™Ã©criture sur tous les fichiers.
* `apparmor-deny-proc-write` : bloque lâ€™Ã©criture dans `/proc`.
* etc.

---

## ğŸ“ 3. Exemples de **profils AppArmor**

Ce sont des fichiers texte comme :

### ğŸ”¸ `apparmor-deny-write` :

```text
profile apparmor-deny-write flags=(attach_disconnected) {
    file,
    deny /** w,
}
```

â¡ï¸ Interdit **lâ€™Ã©criture partout** dans le systÃ¨me.

---

### ğŸ”¸ `apparmor-deny-proc-write` :

```text
profile apparmor-deny-proc-write flags=(attach_disconnected) {
    file,
    deny /proc/* w,
}
```

â¡ï¸ Interdit dâ€™Ã©crire dans le dossier `/proc` (zone sensible du systÃ¨me).

---

### ğŸ”¸ `apparmor-deny-remount-root` :

```text
profile apparmor-deny-remount-root flags=(attach_disconnected) {
    deny mount options=(ro, remount) -> /,
}
```

â¡ï¸ Interdit de **re-monter `/` en lecture seule**, ce qui est une technique dâ€™attaque.

---

## ğŸ“Œ 4. Voir lâ€™Ã©tat des profils

```bash
aa-status
```

Tu verras 3 types de profils :

| Type         | Signification                                                            |
| ------------ | ------------------------------------------------------------------------ |
| `enforce`    | Profil activement appliquÃ© (bloque ce qui est interdit) âœ…                |
| `complain`   | Le profil **nâ€™applique rien**, mais **loggue les actions interdites** ğŸ“‹ |
| `unconfined` | Aucune restriction âŒ                                                     |

---

## ğŸ’¡ Exemple simple dans un scÃ©nario :

Tu as une application web en conteneur. Tu veux :

* Elle peut lire ses fichiers HTML âœ…
* Mais **pas modifier des fichiers systÃ¨me** âŒ
* Et **ne doit pas Ã©crire dans /proc** âŒ

â¡ï¸ Tu appliques un **profil AppArmor personnalisÃ©** qui :

* Autorise `/var/www/html`
* Interdit `/** w` (toute Ã©criture)
* Interdit `/proc/* w`


Voici un **profil AppArmor personnalisÃ©** simple que tu peux utiliser pour une application Web, avec les restrictions que tu as demandÃ©es :

---

### ğŸ” **Nom du fichier** (ex. : `profile-deny-write-proc`)

Chemin conseillÃ© pour le fichier :
`/etc/apparmor.d/profile-deny-write-proc`

---

### âœ… **Contenu du profil AppArmor :**

```bash
profile deny-write-proc flags=(attach_disconnected) {
    # Inclure les rÃ¨gles de base pour AppArmor
    # (accÃ¨s Ã  certaines fonctions standard du systÃ¨me)
    #include <tunables/global>

    # Donner accÃ¨s en lecture au dossier du site web
    /var/www/html/** r,

    # Interdire l'Ã©criture partout
    deny /** w,

    # Interdire lâ€™Ã©criture dans /proc
    deny /proc/* w,

    # Autoriser l'exÃ©cution des binaires nÃ©cessaires (ajuste si besoin)
    /bin/** rix,
    /usr/bin/** rix,
    /lib/** mr,
    /lib64/** mr,
}
```

---

### ğŸ“Œ Ã‰tapes pour appliquer ce profil :

1. ğŸ”§ **CrÃ©er le fichier :**

   ```bash
   sudo nano /etc/apparmor.d/profile-deny-write-proc
   ```

   âœ Colle le contenu ci-dessus et enregistre.

2. âœ… **Activer le profil :**

   ```bash
   sudo apparmor_parser -r /etc/apparmor.d/profile-deny-write-proc
   ```

3. ğŸ” **VÃ©rifier qu'il est bien chargÃ© :**

   ```bash
   sudo aa-status
   ```

4. ğŸ§ª **Appliquer ce profil Ã  un programme ou Ã  un conteneur** (Docker/K8s), selon ton besoin.
