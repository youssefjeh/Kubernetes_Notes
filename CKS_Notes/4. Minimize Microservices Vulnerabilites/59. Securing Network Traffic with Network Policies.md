Voici une version bien structurÃ©e et organisÃ©e de votre **lab "Securing Network Traffic with Network Policies"** pour une meilleure lecture et exÃ©cution :

---

# ğŸ›¡ï¸ Lab : Securing Network Traffic with Kubernetes Network Policies

## ğŸ¯ Objectif

Apprendre Ã  **restreindre le trafic rÃ©seau entre les pods** dâ€™un cluster Kubernetes Ã  lâ€™aide des **Network Policies**.

---

## 1. ğŸ§  Connaissances prÃ©alables

### ğŸ“Œ Ã€ quel niveau du modÃ¨le OSI agissent les Network Policies ?

* **Non pris en charge :** Niveau 2 (Data Link Layer)
* **Pris en charge :** Niveau 3 (Network Layer) et au-dessus

> Les Network Policies se basent sur des adresses IP, ports et labels de pods/namespaces.

---

## 2. ğŸ—ï¸ PrÃ©paration de lâ€™environnement

### ğŸ”¹ CrÃ©ation des namespaces et dÃ©ploiement des pods

| Namespace          | Pod Name      | Image            | Commande     |
| ------------------ | ------------- | ---------------- | ------------ |
| `namespace-web`    | `nginx-pod`   | `nginx`          | -            |
| `namespace-worker` | `busybox-pod` | `busybox`        | `sleep 7600` |
| `namespace-ui`     | `ui-pod`      | `traefik/whoami` | -            |

```bash
kubectl create ns namespace-web
kubectl create ns namespace-worker
kubectl create ns namespace-ui

kubectl label ns namespace-web namespace=namespace-web
kubectl label ns namespace-worker namespace=namespace-worker
kubectl label ns namespace-ui namespace=namespace-ui

kubectl run nginx-pod -n namespace-web --image=nginx
kubectl run busybox-pod -n namespace-worker --image=busybox --command -- sleep 7600
kubectl run ui-pod -n namespace-ui --image=traefik/whoami
```

---

## 3. ğŸ”Œ Test de connectivitÃ© initiale (avant application de policy)

### ğŸ”¹ 3.1. Depuis `busybox-pod` vers `nginx-pod`

```bash
NGINX_IP=$(kubectl get pod nginx-pod -n namespace-web -o jsonpath='{.status.podIP}')
kubectl exec -it busybox-pod -n namespace-worker -- wget -qO- http://$NGINX_IP
```

âœ… **Attendu :** la page HTML de Nginx s'affiche.

---

### ğŸ”¹ 3.2. Depuis `busybox-pod` vers `ui-pod`

```bash
UI_IP=$(kubectl get pod ui-pod -n namespace-ui -o jsonpath='{.status.podIP}')
kubectl exec -it busybox-pod -n namespace-worker -- wget -qO- http://$UI_IP
```

âœ… **Attendu :** connexion rÃ©ussie (avant toute policy).

---

## 4. ğŸ›¡ï¸ Application d'une Network Policy (Ingress uniquement)

### ğŸ”¹ Objectif

Autoriser uniquement le trafic **entrant** de `namespace-web` vers `namespace-ui`.

### ğŸ“„ Fichier `np2.yaml` :

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-specific-ingress
  namespace: namespace-ui
spec:
  podSelector: {}
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              namespace: namespace-web
```

```bash
kubectl apply -f np2.yaml
```

---

## 5. ğŸ” Tests aprÃ¨s application de la Network Policy

### ğŸ”¸ 5.1. `busybox-pod` âœ `nginx-pod`

```bash
NGINX_IP=$(kubectl get pod nginx-pod -n namespace-web -o jsonpath='{.status.podIP}')
kubectl exec -it busybox-pod -n namespace-worker -- wget -qO- http://$NGINX_IP
```

âœ… **RÃ©sultat attendu :** rÃ©ussite.

---

### ğŸ”¸ 5.2. `busybox-pod` âœ `ui-pod`

```bash
UI_IP=$(kubectl get pod ui-pod -n namespace-ui -o jsonpath='{.status.podIP}')
kubectl exec -it busybox-pod -n namespace-worker -- wget -qO- http://$UI_IP
```

âŒ **RÃ©sultat attendu :** Ã©chec (connection refusÃ©e).

---

### ğŸ”¸ 5.3. `nginx-pod` âœ `ui-pod`

```bash
UI_IP=$(kubectl get pod ui-pod -n namespace-ui -o jsonpath='{.status.podIP}')
kubectl exec -it nginx-pod -n namespace-web -- curl http://$UI_IP
```

âœ… **RÃ©sultat attendu :** rÃ©ponse de `whoami`.

---

## 6. ğŸŒ Test dâ€™accÃ¨s Internet depuis `busybox-pod`

```bash
kubectl exec -it busybox-pod -n namespace-worker -- wget -qO- http://google.com
```

âœ… **RÃ©sultat attendu :** contenu HTML de Google s'affiche.

---

## 7. ğŸš« Restriction de lâ€™accÃ¨s Internet avec une Network Policy (Egress)

### ğŸ”¹ Objectif

Bloquer le trafic sortant **vers Internet** mais **autoriser le trafic interne au cluster**.

### ğŸ“„ Fichier `deny-external-egress.yaml` :

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: deny-external-egress
  namespace: namespace-worker
spec:
  podSelector: {}  # SÃ©lectionne tous les pods
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector: {}  # Tous les namespaces
          podSelector: {}        # Tous les pods
```

```bash
kubectl apply -f deny-external-egress.yaml
```

---

### ğŸ”¸ Test d'accÃ¨s externe

```bash
kubectl exec -it busybox-pod -n namespace-worker -- wget -qO- http://google.com || echo "Failed"
```

âŒ **RÃ©sultat attendu :** Ã©chec (connexion bloquÃ©e).

---

## âœ… RÃ©sumÃ©

| Test                              | RÃ©sultat attendu |
| --------------------------------- | ---------------- |
| busybox âœ nginx (intra-cluster)   | âœ…                |
| busybox âœ ui (inter-namespace)    | âŒ                |
| nginx âœ ui (autorisÃ© par policy)  | âœ…                |
| busybox âœ internet (avant egress) | âœ…                |
| busybox âœ internet (aprÃ¨s egress) | âŒ                |


