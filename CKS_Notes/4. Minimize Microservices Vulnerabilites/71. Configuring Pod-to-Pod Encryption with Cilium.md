## ğŸ” **But du Lab**

Tu vas :

1. **Activer le chiffrement entre pods** avec **Cilium + WireGuard**.
2. DÃ©ployer deux pods (`nginx` et `curlpod`) pour tester.
3. VÃ©rifier que le trafic est **bien chiffrÃ©**, donc sÃ©curisÃ©.

---

## ğŸ§± ScÃ©nario Simple : "Parler mais en secret"

Imagine :

* Tu as deux personnes : **Alice (curlpod)** et **Bob (nginx)**.
* Tu veux quâ€™ils **puissent se parler**.
* MAIS : Tu veux que **personne autour ne puisse lire ce quâ€™ils disent**.

ğŸ‘‰ Câ€™est lÃ  quâ€™on utilise **Cilium avec WireGuard**, pour que le **trafic rÃ©seau entre eux soit chiffrÃ© (comme des lettres codÃ©es)**.

---

## ğŸ› ï¸ Ã‰tape 1 â€“ Installer Cilium avec chiffrement activÃ©

### Commandes utilisÃ©es :

```bash
helm repo add cilium https://helm.cilium.io/

helm install cilium cilium/cilium --version v1.18.0-pre.0 \
  --namespace kube-system \
  --set encryption.enabled=true \
  --set encryption.type=wireguard
```

### Que se passe-t-il ici ?

* Tu installes **Cilium** avec **WireGuard**, un protocole VPN ultra lÃ©ger et rapide.
* Il crÃ©e un tunnel **`cilium_wg0`**, qui **chiffre tous les paquets** entre les pods.

ğŸ“˜ **WireGuard**, câ€™est comme une boÃ®te noire : les messages entrent lisibles, sortent chiffrÃ©s, et sont dÃ©chiffrÃ©s uniquement Ã  destination.

---

## ğŸ§ª Ã‰tape 2 â€“ DÃ©ployer deux pods pour tester

### a. DÃ©ployer un serveur `nginx` :

```yaml
# nginx.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx
---
apiVersion: v1
kind: Service
metadata:
  name: nginx
spec:
  selector:
    app: nginx
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
```

### b. DÃ©ployer un client `curlpod` :

```bash
kubectl run curlpod --image=rapidfort/curl --command -- sleep 3600
kubectl label pod curlpod app=curlpod
```

ğŸ“˜ Ce pod ne fait que dormir et attendre. On lâ€™utilise juste pour faire des `curl`, comme si câ€™Ã©tait un navigateur minimaliste.

---

## âœ… Ã‰tape 3 â€“ Tester la communication

```bash
kubectl exec -it curlpod -- curl -s http://nginx
```

> Si tu vois la page HTML NGINX = Ã§a fonctionne.

---

## ğŸ” Ã‰tape 4 â€“ VÃ©rifier que le **trafic est bien chiffrÃ©**

### a. Aller dans un pod Cilium (le garde du rÃ©seau) :

```bash
kubectl -n kube-system exec -ti ds/cilium -- bash
```

### b. VÃ©rifier que WireGuard est bien actif :

```bash
cilium-dbg status | grep Encryption
```

Tu dois voir un truc comme :

```
Encryption: WireGuard, Enabled
WireGuard peers: 1
```

> Ã‡a signifie que **Cilium utilise WireGuard** pour chiffrer le trafic inter-pod.

---

### c. Capturer le trafic sur l'interface WireGuard

```bash
apt update && apt install -y tcpdump

tcpdump -n -i cilium_wg0 -X
```

ğŸ‘€ LÃ  tu regardes les paquets chiffrÃ©s qui passent dans lâ€™interface rÃ©seau crÃ©Ã©e par Cilium.

MÃªme si quelquâ€™un **espionne le rÃ©seau**, il verra des donnÃ©es **illisibles (chiffrÃ©es)** comme :

```
IP 10.0.1.4 > 10.0.2.5: UDP, length 142
... (du code incomprÃ©hensible en hexadÃ©cimal)
```

---

## ğŸ§  RÃ©capitulatif "Version dÃ©butant"

| Ã‰tape | Ce que tu fais                   | Pourquoi                                    |
| ----- | -------------------------------- | ------------------------------------------- |
| 1ï¸âƒ£   | Installer Cilium avec WireGuard  | Pour crÃ©er un tunnel sÃ©curisÃ©               |
| 2ï¸âƒ£   | Lancer nginx + curlpod           | Pour tester la communication                |
| 3ï¸âƒ£   | Faire `curl` de curlpod â†’ nginx  | Pour voir si Ã§a marche                      |
| 4ï¸âƒ£   | Regarder dans Cilium (`tcpdump`) | Pour vÃ©rifier que le trafic est **chiffrÃ©** |

---

## ğŸ’¡ Pourquoi c'est utile en entreprise ?

* ğŸ” **Protection des donnÃ©es** (RGPD, HIPAA, etc.)
* ğŸ§â€â™‚ï¸ğŸ§â€â™€ï¸ **Isolation entre locataires** dans des clusters partagÃ©s
* ğŸ¯ Moins de surface dâ€™attaque rÃ©seau
* âš¡ Performance top grÃ¢ce Ã  eBPF + WireGuard