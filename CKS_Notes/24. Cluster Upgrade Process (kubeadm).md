# ğŸ“ˆ Cluster Upgrade Process (kubeadm)

## Sommaire
1. [PrÃ©requis](#prÃ©requis)
2. [Vue dâ€™ensemble](#vue-densemble)
3. [Mise Ã  niveau du plan de contrÃ´le (Master)](#mise-Ã -niveau-du-plan-de-contrÃ´le-master)
4. [Mise Ã  niveau des nÅ“uds Worker](#mise-Ã -niveau-des-nÅ“uds-worker)
5. [VÃ©rifications post-upgrade](#vÃ©rifications-post-upgrade)
6. [RÃ©fÃ©rences](#rÃ©fÃ©rences)

---

## PrÃ©requis

| Ã‰lÃ©ment | DÃ©tail |
| ------- | ------ |
| AccÃ¨s root / sudo | Sur chaque nÅ“ud |
| Sauvegarde | etcd, manifests, config admin |
| Connexion Internet | Pour `apt` ou dÃ©pÃ´t local Ã©quivalent |
| Versions | Partir de N Ã  N+1 mineur (ex.: 1.11 â†’ 1.12) |

---

## Vue dâ€™ensemble

1. **Plan** : `kubeadm upgrade plan`  
2. **Master** : mettre Ã  niveau `kubeadm`, appliquer lâ€™upgrade, mettre Ã  niveau `kubelet`/`kubectl`.  
3. **Workers (un par un)** : `kubectl drain`, upgrade `kubeadm`, mise Ã  jour de la config puis du `kubelet`, `kubectl uncordon`.  
4. **Validation** : `kubectl get nodes` + tests applicatifs.

---

## Mise Ã  niveau du plan de contrÃ´le (Master)

> âš ï¸ Le nÅ“ud master est dÃ©jÃ  **Unschedulable** par dÃ©faut, pas besoin de le Â« drainer Â».

```bash
# 1) PrÃ©-vÃ©rification
kubectl get nodes
kubeadm version && kubelet --version

# 2) Obtenir le plan dÃ©taillÃ©
kubeadm upgrade plan
```

### Ã‰tape A : mettre Ã  jour le paquet kubeadm

```bash
apt-get update
apt-get install -y kubeadm=1.12.0-00
```

### Ã‰tape B : appliquer la mise Ã  niveau du cluster

```bash
kubeadm upgrade apply v1.12.0
```

### Ã‰tape C : mettre Ã  jour kubelet et kubectl

```bash
apt-get install -y kubelet=1.12.0-00 kubectl=1.12.0-00
systemctl restart kubelet
```

---

## Mise Ã  niveau des nÅ“uds Worker

ProcÃ©der **un nÅ“ud Ã  la fois** pour Ã©viter lâ€™indisponibilitÃ© des workloads.

```bash
# Sur le master :
kubectl drain <node01> --ignore-daemonsets --delete-emptydir-data
```

### Sur le nÅ“ud Worker :

```bash
# 1) kubeadm
apt-get update
apt-get install -y kubeadm=1.12.0-00

# 2) Appliquer la nouvelle configuration du nÅ“ud
kubeadm upgrade node config --kubelet-version v1.12.0

# 3) kubelet + kubectl
apt-get install -y kubelet=1.12.0-00 kubectl=1.12.0-00
systemctl restart kubelet
```

### Re-programmer le nÅ“ud

```bash
# Retour sur le master :
kubectl uncordon <node01>
```

> RÃ©pÃ©tez ces Ã©tapes pour chaque nÅ“ud Worker restant.

---

## VÃ©rifications post-upgrade

```bash
kubectl get nodes -o wide
kubectl get cs           # VÃ©rifier les ComponentStatuses
kubectl get pods -A      # Tous les pods doivent Ãªtre en Ã©tat Running / Completed
```

VÃ©rifiez Ã©galement vos applications mÃ©tier (tests fonctionnels, monitoring, etc.).

---

## RÃ©fÃ©rences

- Documentation officielle : <https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/>
- Notes de version : <https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.12.md>
- Guide pratique du Â« drain Â» : <https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/>

---