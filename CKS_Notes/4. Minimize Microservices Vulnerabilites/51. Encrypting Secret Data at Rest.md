## ğŸ” Demo: Encrypting Secret Data at Rest in Kubernetes

### ğŸš« ProblÃ¨me initial

* Les **secrets Kubernetes** ne sont pas chiffrÃ©s par dÃ©faut dans `etcd`.
* Ils sont **encodÃ©s en Base64**, ce qui nâ€™est **pas sÃ©curisÃ©**.

  ```bash
  echo <secret-base64> | base64 --decode
  ```
* En lisant directement depuis `etcd`, on peut voir les donnÃ©es en **clair** :

  ```bash
  export ETCDCTL_API=3
  etcdctl get /registry/secrets/default/secretName --endpoints=https://127.0.0.1:2379 --cacert=<ca.crt> --cert=<client.crt> --key=<client.key> | hexdump -C
  ```

### ğŸ¯ Objectif

Mettre en place le **chiffrement au repos** (encryption at rest) dans `etcd` pour sÃ©curiser les donnÃ©es sensibles comme les secrets.

---

## âš™ï¸ Ã‰tapes de configuration

### 1. ğŸ” VÃ©rifier que le kube-apiserver utilise un fichier de configuration dâ€™encryption

```bash
ps -aux | grep kube-apiserver | grep "encryption-provider-config"
```

### 2. ğŸ“„ CrÃ©er le fichier de configuration

Voici un exemple de fichier `EncryptionConfiguration.yaml` :

```yaml
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
  - resources:
      - secrets
    providers:
      - aescbc:
          keys:
            - name: key1
              secret: <base64-encoded-32-byte-key>
      - identity: {}
```

> ğŸ” **Remarque** : Le provider `aescbc` doit Ãªtre **placÃ© avant** `identity` pour que le chiffrement soit actif.

### 3. ğŸ”‘ GÃ©nÃ©rer une clÃ© de 32 bytes en base64

```bash
head -c 32 /dev/urandom | base64
```

### 4. ğŸ“Œ Monter le fichier de configuration dans le kube-apiserver

* SpÃ©cifier le chemin via `--encryption-provider-config=/path/to/EncryptionConfiguration.yaml` dans le manifest `kube-apiserver.yaml`.
* S'assurer que le fichier YAML est **montÃ© dans un volume** accessible par le conteneur kube-apiserver.

---

## âœ… VÃ©rification

### Avant chiffrement

```bash
export ETCDCTL_API=3
etcdctl get /registry/secrets/default/secretName | hexdump -C
```

âœ… Les donnÃ©es sont visibles en clair.

### AprÃ¨s chiffrement

* CrÃ©e un **nouveau secret** :

  ```bash
  kubectl create secret generic secretTwo --from-literal=password=TopSecret
  ```

* VÃ©rifie dans `etcd` :

  ```bash
  export ETCDCTL_API=3
  etcdctl get /registry/secrets/default/secretTwo | hexdump -C
  ```

âœ… Le contenu nâ€™est **plus en clair** â€” il est dÃ©sormais chiffrÃ©.

---

## â™»ï¸ RÃ©-encryptage des anciens secrets

> Les secrets existants **ne sont pas automatiquement re-chiffrÃ©s**.

Pour les mettre Ã  jour et dÃ©clencher le chiffrement :

```bash
kubectl get secrets --all-namespaces -o json | kubectl replace -f -
```
