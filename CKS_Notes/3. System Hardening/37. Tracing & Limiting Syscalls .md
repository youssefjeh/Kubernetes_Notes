## ğŸ” Pourquoi tracer ou limiter les **syscalls** est essentiel pour la sÃ©curitÃ© ?

### ğŸ”§ 1. **Quâ€™est-ce quâ€™un syscall ?**

Un **syscall** (appel systÃ¨me) = une commande quâ€™un programme envoie au **noyau Linux** pour faire une action "sensible", comme :

* CrÃ©er un fichier
* Ouvrir un port rÃ©seau
* Lire/Ã©crire en mÃ©moire
* Tuer un processus

â¡ï¸ Chaque action critique passe par un **syscall**.

---

### ğŸš¨ 2. **Pourquoi câ€™est un risque ?**

* Les **malwares, hackers ou processus compromis** utilisent souvent des **syscalls dangereux** pour :

  * Lire des fichiers systÃ¨mes
  * Ã‰lever leurs privilÃ¨ges
  * Lancer des reverse shells
  * Scanner le rÃ©seau, etc.

---

### ğŸ›¡ï¸ 3. **Comment on protÃ¨ge ?**

On utilise 3 techniques :

#### ğŸ” a. **`strace`** pour **observer** les syscalls dâ€™un programme

#### ğŸ§  b. **`tracee`** (via eBPF) pour observer tous les syscalls au niveau systÃ¨me (de maniÃ¨re efficace)

#### ğŸ”’ c. **`seccomp`** pour **restreindre** ce quâ€™un conteneur peut faire (il ne peut utiliser **que** certains syscalls)

---

### âœ… 4. **Un exemple simple :**

Disons que ton conteneur ne fait que lire un fichier JSON.
ğŸ‘‰ Il nâ€™a pas besoin dâ€™accÃ©der au rÃ©seau, ni de forker un autre process.

â†’ GrÃ¢ce Ã  **seccomp**, tu peux lâ€™autoriser Ã  faire uniquement :

* `open`
* `read`
* `write`
* `close`

Et **bloquer tout le reste**.

â¡ï¸ Donc mÃªme si un hacker arrive Ã  injecter un reverse shell dans ton conteneur...
ğŸ’¥ il ne pourra pas lâ€™exÃ©cuter car `execve`, `connect`, `socket` sont **interdits par seccomp**.

---

## âœï¸ Maintenant, organisation propre de tes notes CKS :

---

# ğŸ§© CKS Notes â€” Tracing & Limiting Syscalls

---

## ğŸ§ª 1. **Observer les syscalls avec `strace`**

### â¤ VÃ©rifier si `strace` est installÃ© :

```bash
which strace
```

### â¤ Tracer les syscalls d'une commande :

```bash
strace touch /tmp/error.log
```

### â¤ RÃ©sumer lâ€™utilisation de tous les syscalls :

```bash
strace -c touch /tmp/error.log
```

### â¤ Tracer un processus existant (ex: etcd) :

```bash
pidof etcd    # Ex: 3596
strace -p 3596
```

---

## ğŸ”¬ 2. **Observer avec Tracee (AquaSec)**

### ğŸ”¹ Tracee = outil de tracing basÃ© sur **eBPF**

* Fonctionne dans un conteneur Docker
* NÃ©cessite les headers noyau : `/lib/modules`, `/usr/src`
* Stocke son eBPF dans `/tmp/tracee`
* NÃ©cessite `--privileged` et `--pid=host`

### â¤ Tracer tous les syscalls gÃ©nÃ©rÃ©s par la commande `ls` :

```bash
docker run --rm --privileged --pid=host \
-v /lib/modules:/lib/modules:ro \
-v /usr/src:/usr/src:ro \
-v /tmp/tracee:/tmp/tracee \
aquasec/tracee:0.4.0 --trace comm=ls
```

### â¤ Tracer tous les syscalls de tout nouveau conteneur :

```bash
docker run --rm --privileged --pid=host \
-v /lib/modules:/lib/modules:ro \
-v /usr/src:/usr/src:ro \
-v /tmp/tracee:/tmp/tracee \
aquasec/tracee:0.4.0 --trace pid=new
```

---

## ğŸ›¡ï¸ 3. **Limiter les syscalls avec `seccomp`**

### ğŸ” VÃ©rifier que le noyau supporte seccomp :

```bash
grep -i seccomp /boot/config-$(uname -r)
```

### ğŸ” VÃ©rifier l'Ã©tat seccomp du process PID 1 :

```bash
grep Seccomp /proc/1/status
```

### ğŸ§± Modes de seccomp :

| Mode | Description                 |
| ---- | --------------------------- |
| 0    | DÃ©sactivÃ©                   |
| 1    | Strict                      |
| 2    | FiltrÃ© (avec profil JSON) âœ… |

---

## ğŸ“„ Profils seccomp

### âœ… **Whitelist** (autorise SEULEMENT ce qui est listÃ©)

```json
{
  "defaultAction": "SCMP_ACT_ERRNO",
  "architectures": ["SCMP_ARCH_X86_64"],
  "syscalls": [
    { "names": ["read", "write", "exit"], "action": "SCMP_ACT_ALLOW" }
  ]
}
```

### âŒ **Blacklist** (bloque SEULEMENT ce qui est listÃ©)

```json
{
  "defaultAction": "SCMP_ACT_ALLOW",
  "architectures": ["SCMP_ARCH_X86_64"],
  "syscalls": [
    { "names": ["execve", "connect"], "action": "SCMP_ACT_ERRNO" }
  ]
}
```

---

### â¤ Lancer un conteneur avec un profil seccomp custom :

```bash
docker run -it --rm --security-opt seccomp=/root/custom.json docker/whalesay /bin/sh
```