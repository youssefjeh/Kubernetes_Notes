---

## üß† 1. Qu'est-ce que **Cilium** ?

Cilium est un **plugin r√©seau (CNI)** pour Kubernetes qui :

* Connecte les **pods entre eux** dans un cluster,
* Applique des r√®gles de s√©curit√© r√©seau (comme `NetworkPolicy`),
* Et surtout, utilise **eBPF** pour tout faire **de mani√®re plus rapide, flexible et s√©curis√©e** que les CNIs classiques (comme Calico, Flannel...).

---

## ‚öôÔ∏è 2. Qu‚Äôest-ce que **eBPF** ?

> eBPF = **Extended Berkeley Packet Filter**

üß† Imagine eBPF comme une **mini-machine virtuelle dans le noyau Linux**. Gr√¢ce √† √ßa, tu peux :

* Observer ou modifier le trafic r√©seau en **temps r√©el**,
* Appliquer des r√®gles de s√©curit√© ou des filtres r√©seau **directement dans le noyau**, donc tr√®s rapide,
* Tout √ßa sans modifier le code source du noyau ni red√©marrer quoi que ce soit.

### üß© Exemple simplifi√© :

Quand un **pod A parle √† un pod B**, Cilium (via eBPF) intercepte ce trafic **au niveau du noyau** (et non via iptables) et d√©cide :

* Est-ce que c‚Äôest autoris√© ?
* Est-ce que je dois chiffrer ?
* Est-ce que je log ?
* Est-ce que je bloque ?

---

## üèóÔ∏è 3. Architecture de **Cilium avec eBPF** (version simplifi√©e)

```
           +--------------------+
           |   Kube-apiserver   |
           +--------------------+
                    |
          (CRDs: CiliumNetworkPolicy)
                    |
        +-------------------------+
        |      Cilium Agent       |  <- tourne sur chaque node
        +-------------------------+
        |      eBPF Programs      |  <- inject√©s dans le noyau Linux
        +-------------------------+
        |        Linux Kernel     |
        +-------------------------+
        |       Network Interface |
        +-------------------------+
```

* Les **Cilium Agents** sur chaque n≈ìud g√®rent la config r√©seau.
* Ils injectent des **programmes eBPF** dans le noyau.
* Ces programmes g√®rent la **s√©curit√©, visibilit√© et routage** du trafic.

---

## üõ°Ô∏è 4. Appliquer une **CiliumNetworkPolicy**

Voici un exemple tr√®s simple :

```yaml
apiVersion: "cilium.io/v2"
kind: CiliumNetworkPolicy
metadata:
  name: allow-app-a-to-b
spec:
  endpointSelector:
    matchLabels:
      app: app-b
  ingress:
    - fromEndpoints:
        - matchLabels:
            app: app-a
```

### üßæ Traduction :

* Ce policy dit : **le pod `app-a` a le droit de parler au pod `app-b`**.
* Tout le reste est bloqu√© (r√®gle par d√©faut = deny).

üëâ Contrairement aux `NetworkPolicy` classiques de Kubernetes, **Cilium permet plus de contr√¥le** : DNS, L7 (HTTP), chiffrage...

---

## üîê 5. V√©rifier si le trafic est **chiffr√©**

### üéØ Objectif :

V√©rifier que Cilium chiffre bien les communications entre pods (ex : via **IPsec** ou **WireGuard**, selon config Cilium).

### √âtapes :

#### üìå Sur le pod source :

```bash
kubectl exec -it <pod-name> -- bash
apt-get update && apt-get install -y tcpdump
tcpdump -i eth0 -nn
```

#### üìå Ce que tu dois observer :

Tu verras des lignes comme :

```bash
IP 10.1.0.10 > 10.1.0.11: ESP(spi=0xc1234)
```

* `ESP` = Encapsulating Security Payload = chiffrement IPsec
* Tu **ne vois pas le contenu HTTP/REST**, seulement des paquets chiffr√©s.

---

## ‚úÖ R√©sum√© visuel du test :

```bash
(pod A) --[TCPDUMP]-> (voir ESP packets) --[ebpf]--> (pod B)
```

---

## üìå √Ä retenir :

| √âl√©ment                 | R√¥le                                                            |
| ----------------------- | --------------------------------------------------------------- |
| **eBPF**                | Permet d'intercepter et modifier le trafic r√©seau dans le noyau |
| **Cilium Agent**        | Applique la logique de s√©curit√©                                 |
| **CiliumNetworkPolicy** | D√©finie qui peut parler √† qui                                   |
| **tcpdump sur pod**     | Permet de voir si le trafic est chiffr√© (ESP = IPsec)           |